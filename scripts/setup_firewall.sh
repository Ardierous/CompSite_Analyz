#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∞–π—Ä–≤–æ–ª–∞ UFW –Ω–∞ Ubuntu
# –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç 5000 –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –∏–∑–≤–Ω–µ

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "============================================================"
echo "üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞ UFW –¥–ª—è –ø–æ—Ä—Ç–∞ 5000"
echo "============================================================"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå –û—à–∏–±–∫–∞: —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
    echo "   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: sudo bash scripts/setup_firewall.sh"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è UFW
if ! command -v ufw &> /dev/null; then
    echo "‚ö†Ô∏è  UFW –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    apt-get update
    apt-get install -y ufw
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞
UFW_STATUS=$(ufw status | head -n 1)

echo "üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Ñ–∞–π—Ä–≤–æ–ª–∞: $UFW_STATUS"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞, –æ—Ç–∫—Ä—ã—Ç –ª–∏ –ø–æ—Ä—Ç 5000
if ufw status | grep -q "5000/tcp"; then
    echo "‚úÖ –ü–æ—Ä—Ç 5000 —É–∂–µ –æ—Ç–∫—Ä—ã—Ç –≤ —Ñ–∞–π—Ä–≤–æ–ª–µ"
    PORT_STATUS=$(ufw status | grep "5000/tcp")
    echo "   $PORT_STATUS"
else
    echo "üîì –ü–æ—Ä—Ç 5000 –Ω–µ –æ—Ç–∫—Ä—ã—Ç. –û—Ç–∫—Ä—ã–≤–∞—é..."
    
    # –û—Ç–∫—Ä—ã–≤–∞–µ–º SSH –ø–æ—Ä—Ç (–µ—Å–ª–∏ —Ñ–∞–π—Ä–≤–æ–ª –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω, —ç—Ç–æ –≤–∞–∂–Ω–æ)
    if ! ufw status | grep -q "22/tcp"; then
        echo "üîì –û—Ç–∫—Ä—ã–≤–∞—é SSH –ø–æ—Ä—Ç (22) –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."
        ufw allow 22/tcp
    fi
    
    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç 5000
    ufw allow 5000/tcp
    echo "‚úÖ –ü–æ—Ä—Ç 5000 —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã—Ç"
fi

echo ""

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ñ–∞–π—Ä–≤–æ–ª, –µ—Å–ª–∏ –æ–Ω –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
if echo "$UFW_STATUS" | grep -q "inactive"; then
    echo "üîì –§–∞–π—Ä–≤–æ–ª –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω. –ê–∫—Ç–∏–≤–∏—Ä—É—é..."
    ufw --force enable
    echo "‚úÖ –§–∞–π—Ä–≤–æ–ª –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"
else
    echo "‚úÖ –§–∞–π—Ä–≤–æ–ª —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω"
fi

echo ""
echo "============================================================"
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "============================================================"
echo ""
echo "üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Ñ–∞–π—Ä–≤–æ–ª–∞:"
ufw status | grep -E "(Status|5000|22)" || ufw status
echo ""
echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É:"
echo "   http://$(hostname -I | awk '{print $1}'):5000"
echo "   –∏–ª–∏"
echo "   http://45.133.245.186:5000"
echo ""


