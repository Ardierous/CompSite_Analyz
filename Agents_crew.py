from crewai import Agent, Task, Crew, Process
import os
import json
from datetime import datetime
from pathlib import Path

from dotenv import load_dotenv
load_dotenv()

# Вспомогательная функция для записи в debug.log (опционально)
def write_debug_log(data):
    """Безопасно записывает данные в debug.log, если файл доступен"""
    try:
        debug_log_path = os.getenv('DEBUG_LOG_PATH')
        if not debug_log_path:
            # Пытаемся использовать путь по умолчанию, если он существует
            default_path = Path(__file__).parent / '.cursor' / 'debug.log'
            if default_path.parent.exists():
                debug_log_path = str(default_path)
            else:
                return  # Не записываем, если путь недоступен
        
        with open(debug_log_path, 'a', encoding='utf-8') as f:
            f.write(json.dumps(data) + '\n')
    except:
        pass  # Игнорируем ошибки записи в debug.log

# #region agent log
write_debug_log({
    "sessionId": "debug-session",
    "runId": "init",
    "hypothesisId": "A",
    "location": "Agents_crew.py:7",
    "message": "Импорт CrewAI модулей",
    "data": {"timestamp": datetime.now().isoformat()}
})
# #endregion

# Настройка переменных окружения для OpenAI
api_key = os.getenv("OPENAI_API_KEY")
api_base = os.getenv("OPENAI_API_BASE")

# #region agent log
write_debug_log({
    "sessionId": "debug-session",
    "runId": "init",
    "hypothesisId": "C",
    "location": "Agents_crew.py:15",
    "message": "Проверка переменных окружения телеметрии",
    "data": {
        "CREWAI_TELEMETRY_OPT_OUT": os.getenv("CREWAI_TELEMETRY_OPT_OUT"),
        "CREWAI_TRACING_ENABLED": os.getenv("CREWAI_TRACING_ENABLED"),
        "timestamp": datetime.now().isoformat()
    }
})
# #endregion

# Отключение телеметрии CrewAI
os.environ["CREWAI_TELEMETRY_OPT_OUT"] = "1"
os.environ["CREWAI_TRACING_ENABLED"] = "false"

# #region agent log
write_debug_log({
    "sessionId": "debug-session",
    "runId": "init",
    "hypothesisId": "C",
    "location": "Agents_crew.py:22",
    "message": "Установка переменных для отключения телеметрии",
    "data": {
        "CREWAI_TELEMETRY_OPT_OUT": os.environ.get("CREWAI_TELEMETRY_OPT_OUT"),
        "CREWAI_TRACING_ENABLED": os.environ.get("CREWAI_TRACING_ENABLED"),
        "timestamp": datetime.now().isoformat()
    }
})
# #endregion

if api_key:
    os.environ["OPENAI_API_KEY"] = api_key
if api_base:
    os.environ["OPENAI_API_BASE"] = api_base

# ============================================================================
# АГЕНТ 1: Web Scraper (Считыватель информации с корпоративного сайта)
# ============================================================================

web_scraper_agent = Agent(
    role="Corporate Web Information Specialist",
    goal="Извлечение полной и точной информации с корпоративного сайта компании",
    backstory="""Вы специалист по сбору информации с веб-сайтов компаний. 
    Имеете опыт в работе с различными структурами сайтов, умеете находить 
    и извлекать ключевую информацию: описание компании, услуги, структуру, 
    контакты, финансовые показатели и стратегические документы. 
    Работаете методично и внимательно к деталям.""",
    
    # Основные параметры
    verbose=True,
    allow_delegation=False,
    tools=[],  # Добавьте инструменты для работы с веб
    
    # Параметры LLM
    llm_config={
        "model": "gpt-4",
        "temperature": 0.3,  # Низкая температура для точного извлечения данных
        "max_tokens": 4000,
    },
    
    # Параметры поведения
    max_iter=5,
    max_execution_time=300,  # 5 минут
    memory=True,
)

# ============================================================================
# АГЕНТ 2: Data Analyzer (Анализатор информации)
# ============================================================================

data_analyzer_agent = Agent(
    role="Corporate Data Analyst",
    goal="Анализ и структурирование информации о компании для выявления ключевых паттернов и взаимосвязей",
    backstory="""Вы опытный аналитик с 10+ летним опытом в анализе корпоративной информации.
    Специализируетесь на выявлении тенденций, оценке стратегических направлений,
    анализе конкурентных преимуществ и оценке финансового здоровья компаний.
    Отлично работаете с неструктурированными данными и превращаете их в 
    аналитические выводы. Знакомы с методологией финансового анализа, 
    стратегическим анализом и бизнес-интеллиджензом.""",
    
    verbose=True,
    allow_delegation=False,
    tools=[],
    
    llm_config={
        "model": "gpt-4",
        "temperature": 0.5,  # Средняя температура для аналитического мышления
        "max_tokens": 3000,
    },
    
    max_iter=5,
    max_execution_time=300,
    memory=True,
)

# ============================================================================
# АГЕНТ 3: Business Intelligence Engineer (Инженер BI)
# ============================================================================

bi_engineer_agent = Agent(
    role="Business Intelligence Engineer",
    goal="Формирование сводной информации о компании в структурированном формате с аналитическими выводами",
    backstory="""Вы ведущий инженер бизнес-интеллиджеза с опытом в создании 
    корпоративных аналитических отчетов. Специализируетесь на синтезе различных 
    источников информации в единую картину. Отличаетесь способностью выявлять 
    стратегические риски, возможности и ключевые метрики компании. 
    Знакомы с международными стандартами отчетности и инвестиционного анализа.
    Создаете отчеты для руководства, инвесторов и аналитиков.""",
    
    verbose=True,
    allow_delegation=True,  # Может делегировать другим агентам
    tools=[],
    
    llm_config={
        "model": "gpt-4",
        "temperature": 0.4,  # Точность с элементами синтеза
        "max_tokens": 5000,
    },
    
    max_iter=10,
    max_execution_time=600,  # 10 минут на формирование финального отчета
    memory=True,
)

# ============================================================================
# ОПРЕДЕЛЕНИЕ ЗАДАЧ (TASKS)
# ============================================================================

# ЗАДАЧА 1: Сбор информации с сайта
task_1_scrape = Task(
    description="""Посетите корпоративный сайт {company_url} и извлеките следующую информацию:
    
    1. ОСНОВНАЯ ИНФОРМАЦИЯ:
       - Полное название компании и аббревиатура
       - Краткое описание компании (из раздела "О нас")
       - Год основания и размер компании (количество сотрудников)
    
    2. ПРОДУКТЫ И УСЛУГИ:
       - Полный список основных продуктов/услуг
       - Описание каждого продукта/услуги
       - Целевые рынки и сегменты клиентов
    
    3. СТРУКТУРА КОМПАНИИ:
       - Организационная структура (подразделения, филиалы)
       - Руководство и ключевые должностные лица (если доступно)
       - Количество офисов и географический охват
    
    4. ФИНАНСОВАЯ ИНФОРМАЦИЯ (если доступна):
       - Годовой доход/оборот
       - Финансовые показатели за последние годы
       - Инвестиции и источники финансирования
       - Ссылки на финансовые отчеты
    
    5. СТРАТЕГИЯ И ПЛАНЫ:
       - Миссия и видение компании
       - Ключевые стратегические направления
       - Планы развития и экспансии
       - Инновационные инициативы
    
    6. ИСТОРИЯ КОМПАНИИ:
       - Основные вехи и достижения
       - Ключевые события развития
    
    Извлекайте точные данные со ссылками на источники. Сохраняйте оригинальный текст для критических данных.""",
    
    expected_output="""Структурированный отчет со всей извлеченной информацией, 
    включая исходный текст, ссылки на источники и примечания о качестве данных.""",
    
    agent=web_scraper_agent,
    output_file="task_1_scraped_data.md",
)

# ЗАДАЧА 2: Анализ информации
task_2_analyze = Task(
    description="""На основе информации из Задачи 1, проведите детальный анализ:
    
    1. АНАЛИЗ БИЗНЕС-МОДЕЛИ:
       - Каналы доходов и основные источники прибыли
       - Стратегия позиционирования на рынке
       - Конкурентные преимущества
    
    2. ОЦЕНКА ФИНАНСОВОГО ЗДОРОВЬЯ:
       - Тренды роста (если доступны)
       - Рентабельность и эффективность
       - Финансовая устойчивость
    
    3. АНАЛИЗ ПОРТФЕЛЯ ПРОДУКТОВ:
       - Разнообразие предложений
       - Связь продуктов с целевыми сегментами
       - Инновационность
    
    4. СТРАТЕГИЧЕСКАЯ ПОЗИЦИЯ:
       - Соответствие стратегии рыночным возможностям
       - Потенциальные риски
       - Перспективы роста
    
    5. ВЫЯВЛЕНИЕ СИЛЬНЫХ И СЛАБЫХ СТОРОН:
       - Преимущества
       - Областиsfor improvement
    
    Предоставьте структурированный анализ с выводами и рекомендациями.""",
    
    expected_output="""Детальный аналитический отчет с оценкой ключевых аспектов 
    бизнеса, идентификацией тенденций и выявлением стратегических вопросов.""",
    
    agent=data_analyzer_agent,
    output_file="task_2_analysis.md",
)

# ЗАДАЧА 3: Формирование итоговой сводки
task_3_report = Task(
    description="""На основе информации из Задач 1 и 2, создайте комплексный отчет 
    о компании {company_name} в следующем формате:
    
    КОМПЛЕКСНЫЙ КОРПОРАТИВНЫЙ ОТЧЕТ: {company_name}
    
    I. КРАТКОЕ РЕЗЮМЕ
       - Краткое описание компании в 2-3 предложениях
       - Ключевые финансовые показатели
       - Основные выводы
    
    II. ПРОФИЛЬ КОМПАНИИ
       - Основная информация (название, год основания, размер)
       - Миссия и видение
       - Краткая история развития
       - Текущее положение на рынке
    
    III. ПРОДУКТЫ И УСЛУГИ
       - Основной портфель продуктов/услуг
       - Описание каждого предложения
       - Целевые сегменты клиентов
       - Уникальные предложения (УТП)
    
    IV. ОРГАНИЗАЦИОННАЯ СТРУКТУРА
       - Организационная схема
       - Ключевое руководство
       - Подразделения и их функции
       - Географическое распределение
    
    V. ФИНАНСОВЫЙ ОБЗОР
       - Ключевые финансовые показатели
       - Доходы и прибыль (за доступные периоды)
       - Финансовые тренды
       - Инвестиции и источники финансирования
    
    VI. СТРАТЕГИЧЕСКОЕ НАПРАВЛЕНИЕ
       - Долгосрочные цели
       - Ключевые стратегические инициативы
       - Планы развития и расширения
       - Инновационные проекты
    
    VII. КОНКУРЕНТНЫЙ АНАЛИЗ
       - Основные конкурентные преимущества
       - Позиция на рынке
       - Дифференциация
    
    VIII. РИСКИ И ВОЗМОЖНОСТИ
       - Идентифицированные риски
       - Стратегические возможности
       - Рекомендации
    
    IX. ИНВЕСТИЦИОННЫЕ ПЕРСПЕКТИВЫ
       - Причины инвестировать
       - Перспективы роста
       - Финансовая стабильность
    
    ВСЕ ЗАГОЛОВКИ И СОДЕРЖАНИЕ ОТЧЕТА ДОЛЖНЫ БЫТЬ НА РУССКОМ ЯЗЫКЕ.
    Форматируйте как профессиональный отчет с четкой структурой и аналитическими выводами.""",
    
    expected_output="""Комплексный корпоративный отчет в формате структурированного документа 
    с подробной информацией о компании, финансовом анализе и стратегических выводах. 
    Весь отчет должен быть на русском языке. Отчет должен быть готов для представления инвесторам или руководству.""",
    
    agent=bi_engineer_agent,
    output_file="task_3_final_report.md",
)

# #region agent log
write_debug_log({
    "sessionId": "debug-session",
    "runId": "init",
    "hypothesisId": "A",
    "location": "Agents_crew.py:258",
    "message": "Создание объекта Crew",
    "data": {"timestamp": datetime.now().isoformat()}
})
# #endregion

crew = Crew(
    agents=[web_scraper_agent, data_analyzer_agent, bi_engineer_agent],
    tasks=[task_1_scrape, task_2_analyze, task_3_report],
    verbose=True,
    process="sequential",  # Выполнение задач последовательно
    output_file="crew_output.md",
)

# #region agent log
write_debug_log({
    "sessionId": "debug-session",
    "runId": "init",
    "hypothesisId": "A",
    "location": "Agents_crew.py:264",
    "message": "Объект Crew создан",
    "data": {"timestamp": datetime.now().isoformat()}
})
# #endregion

# ============================================================================
# ЗАПУСК CREW
# ============================================================================

if __name__ == "__main__":
    # Пример использования
    inputs = {
        "company_url": "https://example-company.com",  # Замените на реальный URL
        "company_name": "Example Company",  # Замените на название компании
    }
    
    result = crew.kickoff(inputs=inputs)
    print(result)